{% extends "base.html" %}

{% block title %}{{ boss.name | camel_to_spaces }} - Guild Raid{% endblock %}

{% block content %}
<div class="guild-raid-boss-page">
    <div class="page-header">
        <h1>{{ boss.name | camel_to_spaces }}</h1>
        <span class="boss-rarity">{{ boss.rarity }} {{ boss.set + 1 }}</span>
        {% if updated_at %}
        <span class="last-updated">Last updated: {{ updated_at }}</span>
        {% endif %}
    </div>

    <p><a href="{{ url_for('guild_raid') }}">&larr; Back to Guild Raid</a></p>

    {% if players %}
    <div class="data-section">
        <h2>Player Damage</h2>
        <div class="members-table-wrapper">
            <table class="members-table sortable" id="players-table">
                <thead>
                    <tr>
                        <th data-sort="string">Player</th>
                        <th data-sort="number">#</th>
                        <th data-sort="number">Min</th>
                        <th data-sort="number">Avg</th>
                        <th data-sort="number">Max</th>
                        <th data-sort="number">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for player in players %}
                    <tr>
                        <td>{{ player.username or player.user_id[:8] ~ '...' }}</td>
                        <td>{{ player.attack_count }}</td>
                        <td data-value="{{ player.min_damage }}">{{ '{:,}'.format(player.min_damage) }}</td>
                        <td data-value="{{ player.avg_damage }}">{{ '{:,.0f}'.format(player.avg_damage) }}</td>
                        <td data-value="{{ player.max_damage }}">{{ '{:,}'.format(player.max_damage) }}</td>
                        <td data-value="{{ player.total_damage }}">{{ '{:,}'.format(player.total_damage) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <th>Total</th>
                        <th>{{ players | sum(attribute='attack_count') }}</th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th>{{ '{:,}'.format(players | sum(attribute='total_damage')) }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    {% else %}
    <p class="error">No player data available for this boss.</p>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('players-table');
    if (table) {
        const headers = table.querySelectorAll('th[data-sort]');
        const tbody = table.querySelector('tbody');

        let currentSort = {column: 5, direction: 'desc'};
        headers[5].classList.add('sort-desc');

        headers.forEach((header, index) => {
            header.style.cursor = 'pointer';
            header.addEventListener('click', () => {
                const sortType = header.dataset.sort;
                const direction = (currentSort.column === index && currentSort.direction === 'asc') ? 'desc' : 'asc';

                const rows = Array.from(tbody.querySelectorAll('tr'));

                rows.sort((a, b) => {
                    let aVal, bVal;

                    if (sortType === 'number') {
                        aVal = parseFloat(a.cells[index].dataset.value || a.cells[index].textContent) || 0;
                        bVal = parseFloat(b.cells[index].dataset.value || b.cells[index].textContent) || 0;
                    } else {
                        aVal = a.cells[index].textContent.trim().toLowerCase();
                        bVal = b.cells[index].textContent.trim().toLowerCase();
                    }

                    if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                    return 0;
                });

                rows.forEach(row => tbody.appendChild(row));

                headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
                header.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');

                currentSort = {column: index, direction};
            });
        });
    }
});
</script>
{% endblock %}
