{% extends "base.html" %}

{% block title %}Guild Data - Tacticus Agent{% endblock %}

{% block content %}
<div class="guild-page">
    <h1>Guild Data</h1>

    {% if guild %}
    {% set guild_data = guild.get('guild', guild) %}
    <div class="data-section">
        <h2>Guild Info</h2>
        <div class="info-grid">
            {% if guild_data.get('name') %}
            <div class="info-item">
                <span class="label">Name</span>
                <span class="value">{{ guild_data.name }}</span>
            </div>
            {% endif %}
            {% if guild_data.get('guildTag') %}
            <div class="info-item">
                <span class="label">Tag</span>
                <span class="value">{{ guild_data.guildTag }}</span>
            </div>
            {% endif %}
            {% if guild_data.get('level') %}
            <div class="info-item">
                <span class="label">Level</span>
                <span class="value">{{ guild_data.level }}</span>
            </div>
            {% endif %}
            {% if guild_data.get('members') %}
            <div class="info-item">
                <span class="label">Members</span>
                <span class="value">{{ guild_data.members|length }}</span>
            </div>
            {% endif %}
        </div>
    </div>

    {% if guild_data.get('members') %}
    <div class="data-section">
        <h2>Members</h2>
        <div class="members-table-wrapper">
            <table class="members-table sortable" id="members-table">
                <thead>
                    <tr>
                        <th data-sort="string">Username</th>
                        <th data-sort="string">User ID</th>
                        <th data-sort="role">Role</th>
                        <th data-sort="number">Level</th>
                    </tr>
                </thead>
                <tbody>
                    {% for member in guild_data.members %}
                    <tr>
                        <td>
                            <input type="text"
                                   class="username-input"
                                   data-user-id="{{ member.userId }}"
                                   value="{{ usernames.get(member.userId, '') }}"
                                   placeholder="Enter username">
                        </td>
                        <td>{{ member.userId }}</td>
                        <td data-role="{{ member.role }}">{{ member.role | replace('_', ' ') | title }}</td>
                        <td>{{ member.level }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <div class="data-section">
        <h2>Raw Data</h2>
        <details>
            <summary>View raw JSON response</summary>
            <pre class="raw-json">{{ guild|tojson(indent=2) }}</pre>
        </details>
    </div>

    {% elif error %}
    <div class="error-message">
        <p>{{ error }}</p>
        <p class="hint">Make sure your API key has the "Guild" scope enabled.</p>
    </div>
    {% else %}
    <p class="error">No guild data available.</p>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Username saving
    const usernameInputs = document.querySelectorAll('.username-input');
    usernameInputs.forEach(input => {
        input.addEventListener('change', async function() {
            const userId = this.dataset.userId;
            const username = this.value;

            try {
                const response = await fetch('/api/username', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: userId, username: username})
                });

                if (response.ok) {
                    this.classList.add('saved');
                    setTimeout(() => this.classList.remove('saved'), 1000);
                }
            } catch (error) {
                console.error('Failed to save username:', error);
            }
        });
    });

    // Table sorting
    const table = document.getElementById('members-table');
    if (table) {
        const headers = table.querySelectorAll('th[data-sort]');
        const tbody = table.querySelector('tbody');

        const roleOrder = {'LEADER': 0, 'CO_LEADER': 1, 'OFFICER': 2, 'MEMBER': 3};

        let currentSort = {column: null, direction: 'asc'};

        headers.forEach((header, index) => {
            header.style.cursor = 'pointer';
            header.addEventListener('click', () => {
                const sortType = header.dataset.sort;
                const direction = (currentSort.column === index && currentSort.direction === 'asc') ? 'desc' : 'asc';

                const rows = Array.from(tbody.querySelectorAll('tr'));

                rows.sort((a, b) => {
                    let aVal, bVal;

                    if (sortType === 'number') {
                        aVal = parseFloat(a.cells[index].textContent) || 0;
                        bVal = parseFloat(b.cells[index].textContent) || 0;
                    } else if (sortType === 'role') {
                        aVal = roleOrder[a.cells[index].dataset.role] ?? 99;
                        bVal = roleOrder[b.cells[index].dataset.role] ?? 99;
                    } else {
                        // For username column, get value from input
                        const aInput = a.cells[index].querySelector('input');
                        const bInput = b.cells[index].querySelector('input');
                        aVal = aInput ? aInput.value.toLowerCase() : a.cells[index].textContent.trim().toLowerCase();
                        bVal = bInput ? bInput.value.toLowerCase() : b.cells[index].textContent.trim().toLowerCase();
                    }

                    if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                    return 0;
                });

                rows.forEach(row => tbody.appendChild(row));

                headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
                header.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');

                currentSort = {column: index, direction};
            });
        });
    }
});
</script>
{% endblock %}
